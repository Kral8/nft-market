<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Market | Multi-Chain</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
</head>
<body>
    <div id="activity-feed"></div>

    <nav class="navbar">
        <div class="nav-container">
            <div class="brand"><span>ROYAL MARKET</span></div>
            <div style="display:flex; gap:15px; align-items:center; position: relative;">
                
                <div class="network-dropdown">
                    <div id="active-wallet-info" class="balance-badge" onclick="toggleNetMenu()" style="cursor:pointer; display:none;">
                        <img id="current-net-icon" src="https://cryptologos.cc/logos/toncoin-ton-logo.png" width="16">
                        <span id="display-balance">0.00</span> <span id="display-symbol">TON</span>
                        <i class="fas fa-chevron-down" style="font-size: 10px; margin-left: 5px;"></i>
                    </div>
                    
                    <div id="net-menu" class="dropdown-content">
                        <div class="net-item" onclick="selectActiveNet('ton')">
                            <img src="https://cryptologos.cc/logos/toncoin-ton-logo.png" width="16"> TON Network
                        </div>
                        <div class="net-item" onclick="selectActiveNet('solana')">
                            <img src="https://cryptologos.cc/logos/solana-sol-logo.png" width="16"> Solana
                        </div>
                        <div class="net-item" onclick="selectActiveNet('bsc')">
                            <img src="https://cryptologos.cc/logos/binance-coin-bnb-logo.png" width="16"> BSC (BNB)
                        </div>
                        <div class="net-item" onclick="selectActiveNet('polygon')">
                            <img src="https://cryptologos.cc/logos/polygon-matic-logo.png" width="16"> Polygon
                        </div>
                    </div>
                </div>

                <a href="my-nfts.html" class="nav-link"><i class="fas fa-wallet"></i> My NFTs</a>
                <div id="ton-connect-btn"></div>
            </div>
        </div>
    </nav>

    <div id="app" style="max-width:1200px; margin:0 auto; padding:20px;">
        <header class="hero">
            <h1 class="glitch-text">Elite NFT Market</h1>
            <p>Real-time Multi-chain Marketplace</p>
        </header>

        <div id="nft-grid" class="nft-grid"></div>
    </div>

    <button class="fab-mint" onclick="toggleModal('mint-modal')">
        <i class="fas fa-rocket"></i> Create your NFT
    </button>

    <div id="mint-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Launch New NFT</h2>
                <button onclick="toggleModal('mint-modal')" class="close-btn">&times;</button>
            </div>
            <div class="modal-scroll">
                <label>NFT Name</label>
                <input type="text" id="nft-name" class="modal-input" placeholder="e.g. Ton Moon">
                <label>Ticker</label>
                <input type="text" id="nft-ticker" class="modal-input" placeholder="$TON">
                <label>Image URL (or use default)</label>
                <input type="text" id="nft-img-url" class="modal-input" placeholder="https://...">
                <div class="fee-info" id="fee-display">Fee: 0.3 TON</div>
                <button id="mint-btn" class="buy-btn" onclick="processMint()">Launch NFT</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBT0bsUtte387SIkm3N2hddlvEFSVhB9RU",
            authDomain: "royal-nft.firebaseapp.com",
            projectId: "royal-nft",
            storageBucket: "royal-nft.firebasestorage.app",
            messagingSenderId: "616712040035",
            appId: "1:616712040035:web:59e449b2215e4126951256"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://cute-rugelach-0f683f.netlify.app/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-btn'
        });

        let currentNet = 'ton';
        const netConfig = {
            ton: { symbol: 'TON', icon: 'https://cryptologos.cc/logos/toncoin-ton-logo.png', fee: '0.3 TON' },
            solana: { symbol: 'SOL', icon: 'https://cryptologos.cc/logos/solana-sol-logo.png', fee: '0.02 SOL' },
            bsc: { symbol: 'BNB', icon: 'https://cryptologos.cc/logos/binance-coin-bnb-logo.png', fee: '0.005 BNB' },
            polygon: { symbol: 'POL', icon: 'https://cryptologos.cc/logos/polygon-matic-logo.png', fee: '1 POL' }
        };

        // --- ВЫВОД NFT ИЗ FIREBASE (ВОЗВРАЩЕНО) ---
        const q = query(collection(db, "nfts"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const grid = document.getElementById('nft-grid');
            grid.innerHTML = '';
            snapshot.forEach(d => {
                const nft = d.data();
                const card = document.createElement('div');
                card.className = 'nft-card';
                card.innerHTML = `
                    <img src="${nft.image || 'https://via.placeholder.com/300'}" class="nft-image">
                    <div class="nft-info">
                        <div style="display:flex; justify-content:space-between;">
                            <h3>${nft.name}</h3>
                            <span style="color:var(--text-dim); font-size:12px;">${nft.ticker}</span>
                        </div>
                        <div class="price-tag">${nft.price || 0} ${nft.network?.toUpperCase() || 'TON'}</div>
                        <button class="buy-btn" onclick="buyNFT('${d.id}', '${nft.owner}', ${nft.price}, '${nft.network || 'ton'}')">
                            Buy Now
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        });

        // --- ЛОГИКА БАЛАНСОВ ---
        window.toggleNetMenu = () => {
            const menu = document.getElementById('net-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        };

        window.selectActiveNet = async (net) => {
            currentNet = net;
            document.getElementById('net-menu').style.display = 'none';
            document.getElementById('current-net-icon').src = netConfig[net].icon;
            document.getElementById('display-symbol').innerText = netConfig[net].symbol;
            document.getElementById('fee-display').innerText = `Fee: ${netConfig[net].fee}`;
            await updateBalance();
        };

        async function updateBalance() {
            const balEl = document.getElementById('display-balance');
            balEl.innerText = "...";

            try {
                if (currentNet === 'ton' && tonConnectUI.account) {
                    const res = await fetch(`https://toncenter.com/api/v2/getAddressInformation?address=${tonConnectUI.account.address}`);
                    const data = await res.json();
                    balEl.innerText = data.ok ? (parseInt(data.result.balance) / 1e9).toFixed(2) : "0.00";
                } 
                else if ((currentNet === 'bsc' || currentNet === 'polygon') && window.ethereum) {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const balance = await window.ethereum.request({ method: 'eth_getBalance', params: [accounts[0], 'latest'] });
                    balEl.innerText = (parseInt(balance, 16) / 1e18).toFixed(4);
                }
                else if (currentNet === 'solana' && window.solana) {
                    const resp = await window.solana.connect();
                    const solRes = await fetch('https://api.mainnet-beta.solana.com', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ jsonrpc: "2.0", id: 1, method: "getBalance", params: [resp.publicKey.toString()] })
                    });
                    const solData = await solRes.json();
                    balEl.innerText = solData.result ? (solData.result.value / 1e9).toFixed(2) : "0.00";
                } else {
                    balEl.innerText = "0.00";
                }
            } catch (e) { 
                console.error(e);
                balEl.innerText = "0.00"; 
            }
        }

        // --- ФУНКЦИИ МОДАЛОК И КНОПОК ---
        window.toggleModal = (id) => {
            const m = document.getElementById(id);
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        };

        window.processMint = async () => {
            if (!tonConnectUI.connected) return tonConnectUI.openModal();
            const name = document.getElementById('nft-name').value;
            const ticker = document.getElementById('nft-ticker').value;
            const img = document.getElementById('nft-img-url').value || "https://purple-charming-hamster-277.mypinata.cloud/ipfs/QmXkH2eS98HS6BScHczcmVRF1234cr4UiSX6pQad8n72EE";

            try {
                // Имитация транзакции комиссии
                const tx = {
                    validUntil: Math.floor(Date.now() / 1000) + 300,
                    messages: [{ address: "UQB_rYz84GULTmhLKuOGa6731bsuT-nLELiem9p-u2qI_D98", amount: "300000000" }]
                };
                await tonConnectUI.sendTransaction(tx);

                await addDoc(collection(db, "nfts"), {
                    name, ticker, image: img,
                    owner: tonConnectUI.account.address,
                    price: 1, network: currentNet,
                    createdAt: Date.now()
                });
                alert("NFT Created!");
                toggleModal('mint-modal');
            } catch(e) { alert("Error or Rejected"); }
        };

        tonConnectUI.onStatusChange((wallet) => {
            if(wallet) {
                document.getElementById('active-wallet-info').style.display = 'flex';
                updateBalance();
            }
        });
    </script>
</body>
</html>
