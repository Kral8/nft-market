<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Royal NFT Market</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Telegram -->

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- TON Connect -->

  <script src="https://unpkg.com/@tonconnect/ui@2.0.0/dist/tonconnect-ui.min.js"></script>

  <!-- Firebase -->

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    /* ================= CONFIG ================= */
    const firebaseConfig = {
      apiKey: "AIzaSyBT0bsUtte387SIkm3N2hddlvEFSVhB9RU",
      authDomain: "royal-nft.firebaseapp.com",
      projectId: "royal-nft",
      storageBucket: "royal-nft.firebasestorage.app",
      messagingSenderId: "616712040035",
      appId: "1:616712040035:web:59e449b2215e4126951256"
      measurementId: "G-EXDFRJ78MX"
      };

    const MARKET_OWNER = "UQB_rYz84GULTmhLKuOGa6731bsuT-nLELiem9p-u2qI_D98";
    const MINT_FEE = 0.3;

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ================= TON ================= */
    window.tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: "./tonconnect-manifest.json"
    });

    window.CURRENT_USER = null;

    tonConnectUI.onStatusChange(wallet => {
      if (wallet) {
        CURRENT_USER = wallet.account.address;
        document.getElementById('wallet').innerText = CURRENT_USER.slice(0, 6) + "...";
      }
    });

    /* ================= NFT DATA ================= */
    window.ALL_NFTS = [];

    async function loadNFTs() {
      const snap = await getDocs(collection(db, "nfts"));
      ALL_NFTS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      applyFilter('all');
    }

    window.applyFilter = function(type) {
      let list = [...ALL_NFTS];
      if (type === 'featured') list = list.filter(n => n.featured);
      if (type === 'sale') list = list.filter(n => n.listed && !n.sold);
      if (type === 'new') list.sort((a, b) => b.createdAt - a.createdAt);
      renderNFTs(list);
    }

    function renderNFTs(nfts) {
      const grid = document.getElementById('nft-grid');
      grid.innerHTML = "";

      nfts.forEach(nft => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${nft.image}" />
          <h3>${nft.name}</h3>
          <p>${nft.price} TON</p>
          ${nft.listed && !nft.sold ? `<button onclick="buyNFT('${nft.id}','${nft.owner}',${nft.price})">Buy</button>` : '<span>Sold</span>'}
        `;
        grid.appendChild(card);
      });
    }

    window.buyNFT = async function(id, seller, price) {
      if (!tonConnectUI.connected) return alert('Connect wallet');

      await tonConnectUI.sendTransaction({
        validUntil: Math.floor(Date.now()/1000)+300,
        messages: [{ address: seller, amount: (price*1e9).toString() }]
      });

      await updateDoc(doc(db, 'nfts', id), {
        owner: CURRENT_USER,
        sold: true,
        listed: false,
        soldAt: Date.now()
      });

      loadNFTs();
    }

    window.mintNFT = async function() {
      const name = document.getElementById('m-name').value;
      const price = Number(document.getElementById('m-price').value);
      const image = document.getElementById('m-image').value;

      if (!tonConnectUI.connected) return alert('Connect wallet');

      await tonConnectUI.sendTransaction({
        validUntil: Math.floor(Date.now()/1000)+300,
        messages: [{ address: MARKET_OWNER, amount: (MINT_FEE*1e9).toString() }]
      });

      await addDoc(collection(db,'nfts'),{
        name,image,price,
        owner: CURRENT_USER,
        creator: CURRENT_USER,
        listed:true,
        sold:false,
        featured:false,
        createdAt:Date.now()
      });

      loadNFTs();
    }

    window.onload = loadNFTs;
  </script>

  <style>
    body{background:#0b0b14;color:#fff;font-family:sans-serif;margin:0}
    header{display:flex;justify-content:space-between;align-items:center;padding:15px;background:#111}
    button{padding:10px 15px;border:none;border-radius:6px;background:#6a4cff;color:#fff;cursor:pointer}
    .filters{display:flex;gap:10px;padding:15px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px;padding:15px}
    .card{background:#161625;padding:10px;border-radius:10px;text-align:center}
    .card img{width:100%;border-radius:10px}
    input{width:100%;padding:8px;margin:5px 0;border-radius:6px;border:none}
  </style>

</head>
<body>

<header>
  <img src="logo.png" height="32" />
  <button onclick="tonConnectUI.openModal()">Connect Wallet</button>
  <span id="wallet"></span>
</header>

<div class="filters">
  <button onclick="applyFilter('all')">All</button>
  <button onclick="applyFilter('featured')">‚≠ê Featured</button>
  <button onclick="applyFilter('new')">üÜï New</button>
  <button onclick="applyFilter('sale')">üí∞ For Sale</button>
</div>

<div id="nft-grid" class="grid"></div>

<hr style="margin:30px 0" />

<div style="padding:15px">
  <h2>Create NFT</h2>
  <input id="m-name" placeholder="NFT name" />
  <input id="m-image" placeholder="Image URL (IPFS)" />
  <input id="m-price" placeholder="Price TON" type="number" />
  <button onclick="mintNFT()">Mint (0.3 TON)</button>
</div>

</body>
</html>
