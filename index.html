<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Market | NFT</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="brand"><span>ROYAL MARKET</span></div>
            <div style="display:flex; gap:15px; align-items:center;">
                <a href="my-nfts.html" style="color:white; text-decoration:none;">My NFTs</a>
                <div id="ton-connect-btn"></div>
            </div>
        </div>
    </nav>

    <div id="app" style="max-width:1200px; margin:0 auto; padding:40px 20px;">
        <header style="text-align:center; margin-bottom:50px;">
            <h1 style="font-size:48px; margin-bottom:10px;">Elite NFT Collection</h1>
            <p style="color:var(--text-dim);">Discover, collect, and sell extraordinary NFTs</p>
        </header>

        <div id="nft-grid" class="nft-grid">
            </div>
    </div>

    <button onclick="openMintModal()" style="position:fixed; bottom:30px; right:30px; background:var(--gold); color:black; border:none; width:60px; height:60px; border-radius:50%; font-size:30px; cursor:pointer; box-shadow:0 10px 20px rgba(255,215,0,0.3); font-weight:bold;">+</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBT0bsUtte387SIkm3N2hddlvEFSVhB9RU",
            authDomain: "royal-nft.firebaseapp.com",
            projectId: "royal-nft",
            storageBucket: "royal-nft.firebasestorage.app",
            messagingSenderId: "616712040035",
            appId: "1:616712040035:web:59e449b2215e4126951256"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Исправленная инициализация
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://cute-rugelach-0f683f.netlify.app/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-btn'
        });

        async function loadNFTs() {
            const grid = document.getElementById('nft-grid');
            grid.innerHTML = '<div class="loader"></div>';
            
            const snap = await getDocs(collection(db, "nfts"));
            grid.innerHTML = '';
            
            snap.forEach(d => {
                const nft = d.data();
                const card = document.createElement('div');
                card.className = 'nft-card';
                card.innerHTML = `
                    <img src="${nft.image}" class="nft-image">
                    <div class="nft-info">
                        <h3>${nft.name}</h3>
                        <p style="color:gray; font-size:12px;">Owner: ${nft.owner.slice(0,6)}...${nft.owner.slice(-4)}</p>
                        <div class="price-tag">${nft.price} TON</div>
                        ${tonConnectUI.account?.address === nft.owner ? 
                            '<button class="buy-btn" style="background:gray;" disabled>You own this</button>' : 
                            `<button class="buy-btn" onclick="buyNFT('${d.id}', '${nft.owner}', ${nft.price})">Buy Now</button>`}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        window.buyNFT = async (id, seller, price) => {
            if (!tonConnectUI.connected) return alert("Connect wallet!");
            try {
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 300,
                    messages: [{ address: seller, amount: (price * 1e9).toString() }]
                };
                await tonConnectUI.sendTransaction(transaction);
                await updateDoc(doc(db, "nfts", id), { owner: tonConnectUI.account.address });
                alert("Success!");
                loadNFTs();
            } catch (e) { console.error(e); }
        };

        window.openMintModal = async () => {
            const name = prompt("NFT Name:");
            const img = prompt("Image URL:");
            const price = prompt("Price (TON):");
            if(name && img && price) {
                await addDoc(collection(db, "nfts"), {
                    name, image: img, price: parseFloat(price),
                    owner: tonConnectUI.account.address,
                    createdAt: Date.now()
                });
                loadNFTs();
            }
        };

        tonConnectUI.onStatusChange(() => loadNFTs());
        document.addEventListener('DOMContentLoaded', loadNFTs);
    </script>
</body>
</html>
