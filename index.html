import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBT0bsUtte387SIkm3N2hddlvEFSVhB9RU",
            authDomain: "royal-nft.firebaseapp.com",
            projectId: "royal-nft",
            storageBucket: "royal-nft.firebasestorage.app",
            messagingSenderId: "616712040035",
            appId: "1:616712040035:web:59e449b2215e4126951256"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_ADDRESS = "kQAauN1VLtEh9x9aZkOHqWnngiNwSe0bVkYhM6-cqtGqVU8Y";

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://kral8.github.io/nft-market/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-btn'
        });

        tonConnectUI.onStatusChange(wallet => {
            if (wallet) {
                document.getElementById('active-wallet-info').style.display = 'flex';
                updateBalance(wallet.account.address);
            } else {
                document.getElementById('active-wallet-info').style.display = 'none';
            }
        });

        async function updateBalance(address) {
            try {
                const res = await fetch(`https://testnet.toncenter.com/api/v2/getAddressInformation?address=${address}`);
                const data = await res.json();
                if (data.ok) {
                    const bal = (parseInt(data.result.balance) / 1e9).toFixed(2);
                    document.getElementById('display-balance').innerText = bal;
                }
            } catch (e) { console.error(e); }
        }

        // ФУНКЦИЯ ПОКУПКИ
        window.buyNFT = async (nftId, sellerAddress, price) => {
            if (!tonConnectUI.connected) { alert("Connect wallet!"); tonConnectUI.openModal(); return; }
            try {
                const amountInNano = (price * 1e9).toString();
                await tonConnectUI.sendTransaction({
                    validUntil: Math.floor(Date.now() / 1000) + 300,
                    messages: [{ address: sellerAddress, amount: amountInNano }]
                });

                // Обновляем владельца в базе
                await updateDoc(doc(db, "nfts", nftId), {
                    owner: tonConnectUI.account.address,
                    status: "Sold"
                });
                alert("Purchase successful!");
            } catch (e) { alert("Transaction failed"); }
        };

        window.processMint = async () => {
            if (!tonConnectUI.connected) { alert("Connect wallet!"); tonConnectUI.openModal(); return; }
            const file = document.getElementById('nft-file').files[0];
            const jwt = localStorage.getItem('pinata_jwt');
            if (!file || !jwt) { alert("Check image and admin settings!"); return; }

            const mintBtn = document.getElementById('mint-submit-btn');
            try {
                mintBtn.innerText = "⏳ Uploading...";
                mintBtn.disabled = true;

                const formData = new FormData();
                formData.append('file', file);
                const pinRes = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
                    method: 'POST', headers: { 'Authorization': `Bearer ${jwt}` }, body: formData
                });
                const pinData = await pinRes.json();
                const imageUrl = `https://gateway.pinata.cloud/ipfs/${pinData.IpfsHash}`;

                await tonConnectUI.sendTransaction({
                    validUntil: Math.floor(Date.now() / 1000) + 300,
                    messages: [{ address: COLLECTION_ADDRESS, amount: "200000000", payload: "te6cckEBAQEADgAAGJRqmLYAAAAAAAAAAOnNeQ0=" }]
                });

                await addDoc(collection(db, "nfts"), {
                    name: document.getElementById('nft-name').value || "Unnamed",
                    image: imageUrl,
                    owner: tonConnectUI.account.address, // ТУТ ТЕПЕРЬ СОХРАНЯЕТСЯ ВЛАДЕЛЕЦ
                    price: 0.2,
                    createdAt: Date.now()
                });

                alert("NFT Minted!");
                location.reload();
            } catch (e) { alert("Error!"); } finally { mintBtn.disabled = false; mintBtn.innerText = "Pay & Mint"; }
        };

        const q = query(collection(db, "nfts"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const grid = document.getElementById('nft-grid');
            grid.innerHTML = '';
            snapshot.forEach(docSnap => {
                const nft = docSnap.data();
                const nftId = docSnap.id;
                const isMyNFT = tonConnectUI.account && nft.owner === tonConnectUI.account.address;
                
                const card = document.createElement('div');
                card.className = 'nft-card';
                card.innerHTML = `
                    <img src="${nft.image}" class="nft-image">
                    <div class="nft-info">
                        <h3>${nft.name}</h3>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="price-tag">0.2 TON</div>
                        </div>
                        ${isMyNFT ? 
                            `<button class="buy-btn" style="background:#555" disabled>Your NFT</button>` : 
                            `<button class="buy-btn" onclick="buyNFT('${nftId}', '${nft.owner || COLLECTION_ADDRESS}', 0.2)">Buy Now</button>`
                        }
                    </div>
                `;
                grid.appendChild(card);
            });
        });

        window.toggleModal = (id) => {
            const m = document.getElementById(id);
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        };
