<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My NFTs - Royal Market</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <button onclick="goBack()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">‚Üê</button>
            <div class="brand"><span>My NFTs</span></div>
            <div id="ton-connect-btn"></div>
        </div>
    </nav>

    <div id="app" style="padding:20px;">
        <div style="text-align:center; margin-bottom:30px;">
            <h2 style="color:#ffd700;">Your Digital Collection</h2>
            <p style="color:#8a939b;">NFTs you own and created</p>
        </div>
        
        <div style="margin-bottom:30px;">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button onclick="filterNFTs('all')" class="tab-btn active">All</button>
                <button onclick="filterNFTs('owned')" class="tab-btn">Owned</button>
                <button onclick="filterNFTs('created')" class="tab-btn">Created</button>
                <button onclick="filterNFTs('listed')" class="tab-btn">For Sale</button>
            </div>
            
            <div id="user-stats" style="background:#18202a; padding:20px; border-radius:15px; display:flex; justify-content:space-around; text-align:center;">
                <div>
                    <div style="color:#ffd700; font-size:24px; font-weight:bold;" id="total-nfts">0</div>
                    <div style="color:#8a939b; font-size:14px;">Total NFTs</div>
                </div>
                <div>
                    <div style="color:#2081e2; font-size:24px; font-weight:bold;" id="listed-nfts">0</div>
                    <div style="color:#8a939b; font-size:14px;">Listed</div>
                </div>
                <div>
                    <div style="color:#00b09b; font-size:24px; font-weight:bold;" id="total-value">0</div>
                    <div style="color:#8a939b; font-size:14px;">Total Value</div>
                </div>
            </div>
        </div>
        
        <div id="my-nfts-grid" class="nft-grid">
            <p style="text-align:center; grid-column:1/-1; padding:40px; color:#8a939b;">
                Connect your wallet to see your NFTs...
            </p>
        </div>
        
        <div style="text-align:center; margin-top:40px;">
            <button onclick="window.location.href='index.html'" 
                    style="background:#2081e2; color:white; border:none; padding:12px 30px; border-radius:25px; font-weight:bold; cursor:pointer;">
                ‚Üê Back to Marketplace
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBT0bsUtte387SIkm3N2hddlvEFSVhB9RU",
            authDomain: "royal-nft.firebaseapp.com",
            projectId: "royal-nft",
            storageBucket: "royal-nft.firebasestorage.app",
            messagingSenderId: "616712040035",
            appId: "1:616712040035:web:59e449b2215e4126951256"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: window.location.origin + '/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-btn'
        });
        
        let currentUserAddress = '';
        
        async function loadMyNFTs() {
            const grid = document.getElementById('my-nfts-grid');
            
            if (!currentUserAddress) {
                grid.innerHTML = '<p style="text-align:center; grid-column:1/-1; padding:40px; color:#8a939b;">Connect wallet to see your NFTs</p>';
                return;
            }
            
            grid.innerHTML = '<p style="text-align:center; grid-column:1/-1; padding:40px;"><div class="loader"></div><br>Loading your collection...</p>';
            
            try {
                const querySnapshot = await getDocs(collection(db, "nfts"));
                
                let totalNFTs = 0;
                let listedNFTs = 0;
                let totalValue = 0;
                let nfts = [];
                
                querySnapshot.forEach(doc => {
                    const nft = doc.data();
                    if (nft.owner === currentUserAddress) {
                        nfts.push({ id: doc.id, ...nft });
                        totalNFTs++;
                        totalValue += parseFloat(nft.price || 0);
                        if (!nft.sold) listedNFTs++;
                    }
                });
                
                document.getElementById('total-nfts').textContent = totalNFTs;
                document.getElementById('listed-nfts').textContent = listedNFTs;
                document.getElementById('total-value').textContent = totalValue.toFixed(2) + ' TON';
                
                displayNFTs(nfts);
                
            } catch (error) {
                console.error("Error loading NFTs:", error);
                grid.innerHTML = '<p style="text-align:center; grid-column:1/-1; padding:40px; color:#ff4757;">Error loading your NFTs</p>';
            }
        }
        
        function displayNFTs(nfts) {
            const grid = document.getElementById('my-nfts-grid');
            
            if (nfts.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column:1/-1; text-align:center; padding:60px 20px;">
                        <div style="font-size:60px; margin-bottom:20px;">üñºÔ∏è</div>
                        <h3 style="color:white;">No NFTs yet</h3>
                        <p style="color:#8a939b;">Create your first NFT or buy from marketplace</p>
                        <button onclick="window.location.href='index.html'" 
                                style="margin-top:20px; background:#2081e2; color:white; border:none; padding:12px 24px; border-radius:25px; cursor:pointer;">
                            Go to Marketplace
                        </button>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = '';
            
            nfts.forEach(nft => {
                const div = document.createElement('div');
                div.className = 'nft-card';
                
                div.innerHTML = `
                    <img src="${nft.image}" alt="${nft.name}" 
                         style="width:100%; height:180px; object-fit:cover; border-radius:10px 10px 0 0;">
                    <div style="padding:12px;">
                        <h3 style="margin:0 0 5px 0; color:white; font-size:16px;">${nft.name}</h3>
                        <div style="color:#ffd700; font-weight:bold; font-size:18px;">${parseFloat(nft.price).toFixed(2)} TON</div>
                        <div style="color:#8a939b; font-size:12px; margin-top:5px;">
                            ${nft.sold ? '‚úÖ Sold' : 'üü¢ For Sale'}
                        </div>
                    </div>
                    <div style="display:flex; border-top:1px solid rgba(255,255,255,0.1);">
                        <button onclick="editNFT('${nft.id}')" 
                                style="flex:1; background:transparent; color:#2081e2; border:none; padding:10px; cursor:pointer;">
                            Edit
                        </button>
                        <button onclick="delistNFT('${nft.id}')" 
                                style="flex:1; background:transparent; color:#ff4757; border:none; padding:10px; cursor:pointer; border-left:1px solid rgba(255,255,255,0.1);">
                            Delist
                        </button>
                    </div>
                `;
                
                grid.appendChild(div);
            });
        }
        
        function filterNFTs(filter) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            console.log("Filter by:", filter);
        }
        
        function editNFT(nftId) {
            alert("Edit NFT: " + nftId);
        }
        
        function delistNFT(nftId) {
            if (confirm("Remove this NFT from marketplace?")) {
                alert("Delisting: " + nftId);
            }
        }
        
        function goBack() {
            window.history.back();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram?.WebApp;
            if (tg) {
                tg.expand();
                tg.BackButton.show();
                tg.BackButton.onClick(goBack);
            }
            
            tonConnectUI.onStatusChange((wallet) => {
                if (wallet) {
                    currentUserAddress = wallet.account.address;
                    loadMyNFTs();
                } else {
                    currentUserAddress = '';
                    loadMyNFTs();
                }
            });
        });
    </script>
    
    <style>
        .tab-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.05);
            border: none;
            color: #8a939b;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: #2081e2;
            color: white;
        }
        
        .tab-btn:hover {
            background: rgba(255,255,255,0.1);
        }
    </style>
</body>
</html>
